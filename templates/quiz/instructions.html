{% extends "base.html" %}

{% block title %}{{ quiz.title }} - Instructions - {{ app_name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Quiz Header -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h2 class="mb-0">{{ quiz.title }}</h2>
                </div>
                <div class="card-body">
                    <p class="lead">{{ quiz.description }}</p>
                    
                    {% if quiz.is_eliminatory %}
                    <div class="alert alert-warning" role="alert">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>Attention:</strong> Ce quiz est éliminatoire. Vous devez obtenir un score minimum pour continuer.
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quiz Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="mb-0">Instructions</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="info-item">
                                <i class="bi bi-question-circle text-primary fs-4"></i>
                                <div class="ms-3">
                                    <strong>Nombre de questions</strong>
                                    <p class="mb-0">{{ quiz.question_pool_size or quiz.total_questions }} questions</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="info-item">
                                <i class="bi bi-clock text-primary fs-4"></i>
                                <div class="ms-3">
                                    <strong>Temps limite</strong>
                                    <p class="mb-0">
                                        {% if quiz.time_limit %}
                                            {{ quiz.time_limit }} minutes
                                        {% else %}
                                            Pas de limite
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="info-item">
                                <i class="bi bi-trophy text-primary fs-4"></i>
                                <div class="ms-3">
                                    <strong>Score minimum</strong>
                                    <p class="mb-0">{{ quiz.minimum_score }}%</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="info-item">
                                <i class="bi bi-star text-primary fs-4"></i>
                                <div class="ms-3">
                                    <strong>Points totaux</strong>
                                    <p class="mb-0">{{ quiz.total_points }} points</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <h5>Règles du quiz:</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2"><i class="bi bi-check-circle text-success"></i> Répondez à toutes les questions</li>
                        <li class="mb-2"><i class="bi bi-check-circle text-success"></i> Vos réponses sont sauvegardées automatiquement</li>
                        <li class="mb-2"><i class="bi bi-check-circle text-success"></i> Vous pouvez naviguer entre les questions</li>
                        {% if quiz.time_limit %}
                        <li class="mb-2"><i class="bi bi-check-circle text-success"></i> Le quiz sera soumis automatiquement à la fin du temps imparti</li>
                        {% endif %}
                    </ul>
                </div>
            </div>

            <!-- Previous Attempts -->
            {% if previous_attempts %}
            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="mb-0">Tentatives précédentes</h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Score</th>
                                    <th>Résultat</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for attempt in previous_attempts %}
                                <tr>
                                    <td>{{ attempt.started_at.strftime('%d/%m/%Y %H:%M') }}</td>
                                    <td>{{ "%.0f"|format(attempt.score) }}%</td>
                                    <td>
                                        {% if attempt.passed %}
                                            <span class="badge bg-success">Réussi</span>
                                        {% else %}
                                            <span class="badge bg-danger">Échoué</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('quiz.view_results', quiz_id=quiz.id, attempt_id=attempt.id) }}" 
                                           class="btn btn-sm btn-outline-primary">
                                            Voir les résultats
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Start Button -->
            <div class="text-center">
                {% if can_retake %}
                <form id="startQuizForm" method="POST" action="{{ url_for('quiz.start_quiz_attempt', quiz_id=quiz.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-success btn-lg" id="startQuizBtn">
                        <i class="bi bi-play-circle-fill"></i> Commencer le Quiz
                    </button>
                </form>
                {% else %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    {{ retake_reason or "Vous ne pouvez pas reprendre ce quiz pour le moment." }}
                </div>
                <a href="{{ url_for('training.list_trainings') }}" class="btn btn-primary">
                    Retour aux formations
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<style>
    .info-item {
        display: flex;
        align-items: flex-start;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('startQuizForm');
        const btn = document.getElementById('startQuizBtn');
        
        if (form && btn) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Disable button to prevent double submission
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Démarrage...';
                
                // Submit via AJAX
                fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = data.redirect_url;
                    } else {
                        alert(data.error || 'Une erreur est survenue');
                        btn.disabled = false;
                        btn.innerHTML = '<i class="bi bi-play-circle-fill"></i> Commencer le Quiz';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Une erreur est survenue lors du démarrage du quiz');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-play-circle-fill"></i> Commencer le Quiz';
                });
            });
        }
    });
</script>
{% endblock %}
